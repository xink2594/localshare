<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalShare - P2P File Transfer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #3498db;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        h1 {
            margin: 0;
        }
        
        .device-info {
            background-color: #fff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .device-list {
            background-color: #fff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .device-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item:hover {
            background-color: #f9f9f9;
        }
        
        .file-transfer {
            background-color: #fff;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .file-input {
            margin: 15px 0;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border-left: 4px solid #3498db;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }
        
        .transfer-request {
            background-color: #fff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .transfer-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .reject-btn {
            background-color: #e74c3c;
        }
        
        .reject-btn:hover {
            background-color: #c0392b;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        progress {
            width: 100%;
            height: 20px;
        }
        
        .transfer-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>LocalShare</h1>
            <p>P2P File Transfer in Local Network</p>
        </header>
        
        <div class="device-info">
            <h2>Your Device</h2>
            <p>Device ID: <span id="device-id">Connecting...</span></p>
            <p>Device Name: <span id="device-name">Connecting...</span></p>
            <p>Status: <span id="connection-status">Connecting...</span></p>
        </div>
        
        <div class="device-list">
            <h2>Available Devices</h2>
            <div id="devices-container">
                <p>Searching for devices...</p>
            </div>
        </div>
        
        <div id="file-transfer" class="file-transfer">
            <h2>Send File to <span id="target-device-name"></span></h2>
            <div class="file-input">
                <input type="file" id="file-input">
            </div>
            <button id="send-file-btn">Send File</button>
            
            <div id="progress-container" class="progress-container">
                <h3>Transfer Progress</h3>
                <progress id="transfer-progress" value="0" max="100"></progress>
                <div class="transfer-info">
                    <span id="transfer-percentage">0%</span>
                    <span id="transfer-speed">0 KB/s</span>
                    <span id="transfer-remaining">Calculating...</span>
                </div>
            </div>
        </div>
        
        <div id="transfer-request" class="transfer-request">
            <h2>File Transfer Request</h2>
            <p>From: <span id="source-device-name"></span></p>
            <p>File: <span id="requested-file-name"></span></p>
            <p>Size: <span id="requested-file-size"></span></p>
            <div class="transfer-actions">
                <button id="accept-transfer-btn">Accept</button>
                <button id="reject-transfer-btn" class="reject-btn">Reject</button>
            </div>
            
            <div id="receiver-progress-container" class="progress-container">
                <h3>Receiving File</h3>
                <progress id="receiver-progress" value="0" max="100"></progress>
                <div class="transfer-info">
                    <span id="receiver-percentage">0%</span>
                    <span id="receiver-speed">0 KB/s</span>
                    <span id="receiver-remaining">Calculating...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Constants
        const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
        
        // Variables
        let socket;
        let deviceId = '';
        let deviceName = '';
        let targetDeviceId = '';
        let targetDeviceName = '';
        let currentTransferId = '';
        let selectedFile = null;
        let receivingFile = null;
        let receivedChunks = [];
        let receivedSize = 0;
        let totalSize = 0;
        let transferStartTime = 0;
        
        // Elements
        const deviceIdElement = document.getElementById('device-id');
        const deviceNameElement = document.getElementById('device-name');
        const connectionStatusElement = document.getElementById('connection-status');
        const devicesContainer = document.getElementById('devices-container');
        const fileTransferElement = document.getElementById('file-transfer');
        const targetDeviceNameElement = document.getElementById('target-device-name');
        const fileInput = document.getElementById('file-input');
        const sendFileBtn = document.getElementById('send-file-btn');
        const progressContainer = document.getElementById('progress-container');
        const transferProgress = document.getElementById('transfer-progress');
        const transferPercentage = document.getElementById('transfer-percentage');
        const transferSpeed = document.getElementById('transfer-speed');
        const transferRemaining = document.getElementById('transfer-remaining');
        const transferRequestElement = document.getElementById('transfer-request');
        const sourceDeviceNameElement = document.getElementById('source-device-name');
        const requestedFileNameElement = document.getElementById('requested-file-name');
        const requestedFileSizeElement = document.getElementById('requested-file-size');
        const acceptTransferBtn = document.getElementById('accept-transfer-btn');
        const rejectTransferBtn = document.getElementById('reject-transfer-btn');
        const receiverProgressContainer = document.getElementById('receiver-progress-container');
        const receiverProgress = document.getElementById('receiver-progress');
        const receiverPercentage = document.getElementById('receiver-percentage');
        const receiverSpeed = document.getElementById('receiver-speed');
        const receiverRemaining = document.getElementById('receiver-remaining');
        const notificationElement = document.getElementById('notification');
        
        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/file-transfer`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                connectionStatusElement.textContent = 'Connected';
                connectionStatusElement.style.color = 'green';
                showNotification('Connected to server');
            };
            
            socket.onclose = () => {
                connectionStatusElement.textContent = 'Disconnected';
                connectionStatusElement.style.color = 'red';
                showNotification('Disconnected from server');
                
                // Try to reconnect after 5 seconds
                setTimeout(() => {
                    showNotification('Attempting to reconnect...');
                    initWebSocket();
                }, 5000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                connectionStatusElement.textContent = 'Error';
                connectionStatusElement.style.color = 'red';
            };
            
            socket.onmessage = handleMessage;
        }
        
        // Handle incoming WebSocket messages
        function handleMessage(event) {
            if (event.data instanceof Blob) {
                handleBinaryMessage(event.data);
            } else {
                handleTextMessage(event.data);
            }
        }
        
        // Handle text messages (JSON)
        function handleTextMessage(data) {
            const message = JSON.parse(data);
            
            switch (message.type) {
                case 'device_info':
                    deviceId = message.deviceId;
                    deviceName = message.deviceName;
                    deviceIdElement.textContent = deviceId;
                    deviceNameElement.textContent = deviceName;
                    break;
                    
                case 'device_list':
                    updateDeviceList(message.deviceList);
                    break;
                    
                case 'transfer_request':
                    handleTransferRequest(message);
                    break;
                    
                case 'transfer_response':
                    handleTransferResponse(message);
                    break;
                    
                case 'file_metadata':
                    handleFileMetadata(message);
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }
        
        // Handle binary messages (file chunks)
        function handleBinaryMessage(blob) {
            if (!receivingFile) return;
            
            receivedChunks.push(blob);
            receivedSize += blob.size;
            
            // Update progress
            const progress = Math.round((receivedSize / totalSize) * 100);
            receiverProgress.value = progress;
            receiverPercentage.textContent = `${progress}%`;
            
            // Calculate speed
            const elapsedTime = (Date.now() - transferStartTime) / 1000;
            const speedBps = receivedSize / elapsedTime;
            receiverSpeed.textContent = `${formatSpeed(speedBps)}`;
            
            // Calculate remaining time
            const remainingBytes = totalSize - receivedSize;
            const remainingTime = remainingBytes / speedBps;
            receiverRemaining.textContent = `${formatTime(remainingTime)}`;
            
            // Check if transfer is complete
            if (receivedSize >= totalSize) {
                completeFileReceive();
            }
        }
        
        // Update the device list
        function updateDeviceList(devices) {
            if (!devices || devices.length === 0) {
                devicesContainer.innerHTML = '<p>No devices found</p>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                // Skip own device
                if (device.deviceId === deviceId) return;
                
                html += `
                    <div class="device-item" data-device-id="${device.deviceId}" data-device-name="${device.deviceName}">
                        <span>${device.deviceName}</span>
                        <button class="select-device-btn">Select</button>
                    </div>
                `;
            });
            
            if (html === '') {
                devicesContainer.innerHTML = '<p>No other devices found</p>';
            } else {
                devicesContainer.innerHTML = html;
                
                // Add event listeners to select buttons
                document.querySelectorAll('.select-device-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deviceItem = this.parentElement;
                        selectDevice(
                            deviceItem.getAttribute('data-device-id'),
                            deviceItem.getAttribute('data-device-name')
                        );
                    });
                });
            }
        }
        
        // Select a device to send files to
        function selectDevice(deviceId, deviceName) {
            targetDeviceId = deviceId;
            targetDeviceName = deviceName;
            
            targetDeviceNameElement.textContent = deviceName;
            fileTransferElement.style.display = 'block';
            
            showNotification(`Selected device: ${deviceName}`);
        }
        
        // Send a file transfer request
        function sendFileTransferRequest() {
            if (!selectedFile || !targetDeviceId) return;
            
            const message = {
                type: 'request_transfer',
                targetDeviceId: targetDeviceId,
                fileName: selectedFile.name,
                fileSize: selectedFile.size,
                fileType: selectedFile.type
            };
            
            socket.send(JSON.stringify(message));
            showNotification(`Transfer request sent to ${targetDeviceName}`);
        }
        
        // Handle incoming transfer request
        function handleTransferRequest(message) {
            currentTransferId = message.transferId;
            sourceDeviceNameElement.textContent = message.sourceDeviceName;
            requestedFileNameElement.textContent = message.fileName;
            requestedFileSizeElement.textContent = formatSize(message.fileSize);
            
            // Store file information
            totalSize = message.fileSize;
            
            transferRequestElement.style.display = 'block';
            showNotification(`File transfer request from ${message.sourceDeviceName}`);
        }
        
        // Handle transfer response (accept/reject)
        function handleTransferResponse(message) {
            if (message.accepted) {
                showNotification('Transfer accepted! Starting file transfer...');
                startFileSending();
            } else {
                showNotification('Transfer rejected by recipient.');
                resetSendState();
            }
        }
        
        // Handle file metadata message
        function handleFileMetadata(message) {
            // Prepare for receiving file
            receivingFile = {
                name: message.fileName,
                size: message.fileSize,
                type: message.fileType
            };
            
            receivedChunks = [];
            receivedSize = 0;
            totalSize = message.fileSize;
            transferStartTime = Date.now();
            
            // Show progress
            receiverProgressContainer.style.display = 'block';
            receiverProgress.max = 100;
            receiverProgress.value = 0;
        }
        
        // Start sending the file in chunks
        function startFileSending() {
            if (!selectedFile) return;
            
            // Show progress
            progressContainer.style.display = 'block';
            transferProgress.max = 100;
            transferProgress.value = 0;
            
            // Send file metadata
            const metadata = {
                type: 'file_metadata',
                transferId: currentTransferId,
                fileName: selectedFile.name,
                fileSize: selectedFile.size,
                fileType: selectedFile.type
            };
            
            socket.send(JSON.stringify(metadata));
            
            // Start transfer time tracking
            transferStartTime = Date.now();
            
            // Start sending chunks
            sendFileChunks(selectedFile, 0);
        }
        
        // Send file in chunks
        function sendFileChunks(file, offset) {
            if (offset >= file.size) {
                // Transfer complete
                showNotification('File transfer complete!');
                resetSendState();
                return;
            }
            
            const chunk = file.slice(offset, offset + CHUNK_SIZE);
            socket.send(chunk);
            
            // Update progress
            const progress = Math.round((offset / file.size) * 100);
            transferProgress.value = progress;
            transferPercentage.textContent = `${progress}%`;
            
            // Calculate speed
            const elapsedTime = (Date.now() - transferStartTime) / 1000;
            const speedBps = offset / elapsedTime;
            transferSpeed.textContent = `${formatSpeed(speedBps)}`;
            
            // Calculate remaining time
            const remainingBytes = file.size - offset;
            const remainingTime = remainingBytes / speedBps;
            transferRemaining.textContent = `${formatTime(remainingTime)}`;
            
            // Continue with next chunk after a short delay
            setTimeout(() => {
                sendFileChunks(file, offset + CHUNK_SIZE);
            }, 10);
        }
        
        // Complete file receiving and trigger download
        function completeFileReceive() {
            showNotification('File received successfully!');
            
            // Create a blob from all chunks
            const fileBlob = new Blob(receivedChunks, { type: receivingFile.type || 'application/octet-stream' });
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(fileBlob);
            downloadLink.download = receivingFile.name;
            downloadLink.style.display = 'none';
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Reset state
            resetReceiveState();
        }
        
        // Reset send state
        function resetSendState() {
            selectedFile = null;
            fileInput.value = '';
            progressContainer.style.display = 'none';
            transferProgress.value = 0;
        }
        
        // Reset receive state
        function resetReceiveState() {
            receivingFile = null;
            receivedChunks = [];
            receivedSize = 0;
            totalSize = 0;
            transferRequestElement.style.display = 'none';
            receiverProgressContainer.style.display = 'none';
            receiverProgress.value = 0;
        }
        
        // Show notification
        function showNotification(message) {
            notificationElement.textContent = message;
            notificationElement.style.display = 'block';
            
            setTimeout(() => {
                notificationElement.style.display = 'none';
            }, 5000);
        }
        
        // Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        
        // Format transfer speed
        function formatSpeed(bps) {
            if (bps < 1024) return bps.toFixed(2) + ' B/s';
            if (bps < 1024 * 1024) return (bps / 1024).toFixed(2) + ' KB/s';
            return (bps / (1024 * 1024)).toFixed(2) + ' MB/s';
        }
        
        // Format time
        function formatTime(seconds) {
            if (seconds < 60) return seconds.toFixed(0) + ' sec';
            if (seconds < 3600) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}m ${secs}s`;
            }
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        }
        
        // Event listeners
        fileInput.addEventListener('change', function() {
            selectedFile = this.files[0];
            if (selectedFile) {
                showNotification(`Selected file: ${selectedFile.name} (${formatSize(selectedFile.size)})`);
            }
        });
        
        sendFileBtn.addEventListener('click', function() {
            if (selectedFile) {
                sendFileTransferRequest();
            } else {
                showNotification('Please select a file first');
            }
        });
        
        acceptTransferBtn.addEventListener('click', function() {
            const response = {
                type: 'transfer_response',
                transferId: currentTransferId,
                accepted: true
            };
            
            socket.send(JSON.stringify(response));
        });
        
        rejectTransferBtn.addEventListener('click', function() {
            const response = {
                type: 'transfer_response',
                transferId: currentTransferId,
                accepted: false
            };
            
            socket.send(JSON.stringify(response));
            resetReceiveState();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
        });
    </script>
</body>
</html>