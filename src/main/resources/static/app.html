<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalShare - P2Pæ–‡ä»¶ä¼ è¾“</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3498db;
            text-align: center;
        }
        .device-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #eaf2f8;
            border-radius: 5px;
            position: relative;
        }
        .info-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-style: italic;
            font-weight: bold;
            font-family: serif;
        }
        .info-tooltip {
            position: absolute;
            top: 45px;
            right: 0;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
            width: 220px;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .info-tooltip:after {
            content: '';
            position: absolute;
            top: -10px;
            right: 10px;
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent #2c3e50 transparent;
        }
        .device-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #2980b9;
            padding: 5px 10px;
            background-color: #d6eaf8;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .device-list {
            margin-bottom: 20px;
        }
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .device-item button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .file-transfer {
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf2f8;
            border-radius: 5px;
            display: none;
        }
        .notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            transition: top 0.5s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            min-width: 200px;
            text-align: center;
        }
        .progress-container {
            margin-top: 10px;
        }
        progress {
            width: 100%;
            height: 20px;
        }
        .transfer-request {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9e79f;
            border-radius: 5px;
            display: none;
        }
        .transfer-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        button {
            cursor: pointer;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
        }
        #send-button {
            background-color: #27ae60;
            color: white;
            font-size: 1.1em;
            padding: 10px 20px;
            font-weight: bold;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #send-button:hover {
            background-color: #2ecc71;
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        .icon {
            display: inline-block;
            margin-right: 5px;
            font-family: Arial, sans-serif;
        }
        .refresh-button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: transform 0.3s;
        }
        .refresh-button:hover {
            background-color: #2980b9;
            transform: rotate(180deg);
        }
        .device-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .accept-btn {
            background-color: #2ecc71;
            color: white;
        }
        .reject-btn {
            background-color: #e74c3c;
            color: white;
        }
        .file-input {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .file-input input[type="file"] {
            padding: 8px;
            border: 1px dashed #3498db;
            border-radius: 4px;
            background-color: #f8f9fa;
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LocalShare æ–‡ä»¶ä¼ è¾“</h1>
        
        <div class="device-info">
            <h2>æˆ‘çš„è®¾å¤‡</h2>
            <div class="info-icon" id="info-icon">i
                <div class="info-tooltip" id="info-tooltip">
                    <p>IPåœ°å€: <span id="ip-address">è·å–ä¸­...</span></p>
                    <p>WebSocketç«¯å£: <span id="ws-port">è·å–ä¸­...</span></p>
                    <p>è¿æ¥åœ°å€: <span id="full-address">è·å–ä¸­...</span></p>
                </div>
            </div>
            <p>è®¾å¤‡ID: <span id="device-id" style="font-family: monospace;">è¿æ¥ä¸­...</span></p>
            <p>è®¾å¤‡åç§°: <span id="device-name" class="device-name">è¿æ¥ä¸­...</span></p>
            <p>è¿æ¥çŠ¶æ€: <span id="connection-status">è¿æ¥ä¸­...</span></p>
        </div>
        
        <div class="device-list">
            <div class="device-list-header">
                <h2>å¯ç”¨è®¾å¤‡</h2>
                <button class="refresh-button" id="refresh-button" title="åˆ·æ–°è®¾å¤‡åˆ—è¡¨">â†»</button>
            </div>
            <div id="devices-container">
                <p>æ­£åœ¨æœç´¢è®¾å¤‡...</p>
            </div>
        </div>
        
        <div id="file-transfer" class="file-transfer">
            <h2>å‘é€æ–‡ä»¶åˆ° <span id="target-device-name" class="device-name"></span></h2>
            <div class="file-input">
                <input type="file" id="file-input">
                <button id="send-button"><span class="icon">ğŸ“¤</span> å‘é€æ–‡ä»¶</button>
            </div>
            
            <div id="progress-container" class="progress-container" style="display:none;">
                <h3>ä¼ è¾“è¿›åº¦</h3>
                <progress id="progress-bar" value="0" max="100"></progress>
                <p><span id="progress-percent">0%</span> - <span id="transfer-speed">0 KB/s</span></p>
            </div>
        </div>
        
        <div id="transfer-request" class="transfer-request">
            <h2>æ–‡ä»¶ä¼ è¾“è¯·æ±‚</h2>
            <p>æ¥è‡ª: <span id="source-device-name" class="device-name"></span></p>
            <p>æ–‡ä»¶: <span id="file-name"></span> (<span id="file-size"></span>)</p>
            
            <div class="transfer-actions">
                <button id="accept-button" class="accept-btn">æ¥å—</button>
                <button id="reject-button" class="reject-btn">æ‹’ç»</button>
            </div>
            
            <div id="receiver-progress" class="progress-container" style="display:none;">
                <h3>æ¥æ”¶è¿›åº¦</h3>
                <progress id="receiver-bar" value="0" max="100"></progress>
                <p><span id="receiver-percent">0%</span> - <span id="receiver-speed">0 KB/s</span></p>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // å¸¸é‡
        const CHUNK_SIZE = 1024 * 1024; // 1MB åˆ†ç‰‡
        
        // å˜é‡
        let socket;
        let deviceId = '';
        let deviceName = '';
        let targetDeviceId = '';
        let targetDeviceName = '';
        let currentTransferId = '';
        let selectedFile = null;
        let receivingFile = null;
        let receivedChunks = [];
        let receivedSize = 0;
        let totalSize = 0;
        let transferStartTime = 0;
        let reconnectAttempts = 0;
        let reconnectTimer = null;
        let maxReconnectAttempts = 10;
        
        // DOM å…ƒç´ 
        const deviceIdElement = document.getElementById('device-id');
        const deviceNameElement = document.getElementById('device-name');
        const statusElement = document.getElementById('connection-status');
        const devicesContainer = document.getElementById('devices-container');
        const fileTransferElement = document.getElementById('file-transfer');
        const targetDeviceNameElement = document.getElementById('target-device-name');
        const fileInput = document.getElementById('file-input');
        const sendButton = document.getElementById('send-button');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const transferSpeed = document.getElementById('transfer-speed');
        const transferRequestElement = document.getElementById('transfer-request');
        const sourceDeviceNameElement = document.getElementById('source-device-name');
        const fileNameElement = document.getElementById('file-name');
        const fileSizeElement = document.getElementById('file-size');
        const acceptButton = document.getElementById('accept-button');
        const rejectButton = document.getElementById('reject-button');
        const receiverProgressElement = document.getElementById('receiver-progress');
        const receiverBar = document.getElementById('receiver-bar');
        const receiverPercent = document.getElementById('receiver-percent');
        const receiverSpeed = document.getElementById('receiver-speed');
        const notificationElement = document.getElementById('notification');
        
        // åˆå§‹åŒ– WebSocket
        function initWebSocket() {
            // æ¸…é™¤ä¹‹å‰çš„é‡è¿å®šæ—¶å™¨
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/file-transfer`;
            
            try {
                socket = new WebSocket(wsUrl);
                
                socket.onopen = () => {
                    statusElement.textContent = 'å·²è¿æ¥';
                    statusElement.style.color = 'green';
                    showNotification('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    // é‡ç½®é‡è¿è®¡æ•°
                    reconnectAttempts = 0;
                };
                
                socket.onclose = () => {
                    statusElement.textContent = 'å·²æ–­å¼€è¿æ¥';
                    statusElement.style.color = 'red';
                    
                    // æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥
                    reconnectAttempts++;
                    const delay = Math.min(5000 * Math.pow(1.5, reconnectAttempts - 1), 60000);
                    
                    if (reconnectAttempts <= maxReconnectAttempts) {
                        showNotification(`å·²æ–­å¼€è¿æ¥ï¼Œ${Math.round(delay/1000)}ç§’åå°è¯•é‡è¿...ï¼ˆ${reconnectAttempts}/${maxReconnectAttempts}ï¼‰`);
                        
                        // è®¾ç½®é‡è¿å®šæ—¶å™¨
                        reconnectTimer = setTimeout(() => {
                            showNotification(`æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...ï¼ˆ${reconnectAttempts}/${maxReconnectAttempts}ï¼‰`);
                            initWebSocket();
                        }, delay);
                    } else {
                        showNotification('é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                };
                
                socket.onerror = (error) => {
                    console.error('WebSocket é”™è¯¯:', error);
                    statusElement.textContent = 'è¿æ¥é”™è¯¯';
                    statusElement.style.color = 'red';
                };
                
                socket.onmessage = handleMessage;
            } catch (error) {
                console.error('WebSocket åˆå§‹åŒ–é”™è¯¯:', error);
                statusElement.textContent = 'è¿æ¥å¤±è´¥';
                statusElement.style.color = 'red';
                
                // å°è¯•é‡è¿
                reconnectAttempts++;
                const delay = Math.min(5000 * Math.pow(1.5, reconnectAttempts - 1), 60000);
                
                if (reconnectAttempts <= maxReconnectAttempts) {
                    showNotification(`è¿æ¥å¤±è´¥ï¼Œ${Math.round(delay/1000)}ç§’åå°è¯•é‡è¿...ï¼ˆ${reconnectAttempts}/${maxReconnectAttempts}ï¼‰`);
                    reconnectTimer = setTimeout(initWebSocket, delay);
                } else {
                    showNotification('é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }
        }
        
        // å¤„ç† WebSocket æ¶ˆæ¯
        function handleMessage(event) {
            if (event.data instanceof Blob) {
                // äºŒè¿›åˆ¶æ•°æ® - æ–‡ä»¶åˆ†ç‰‡
                handleBinaryMessage(event.data);
            } else {
                // æ–‡æœ¬æ•°æ® - JSON æ¶ˆæ¯
                handleTextMessage(event.data);
            }
        }
        
        // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
        function handleTextMessage(data) {
            const message = JSON.parse(data);
            console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
            
            switch (message.type) {
                case 'device_info':
                    deviceId = message.deviceId;
                    deviceName = message.deviceName;
                    deviceIdElement.textContent = deviceId;
                    deviceNameElement.textContent = deviceName;
                    break;
                    
                case 'device_list':
                    updateDeviceList(message.deviceList);
                    break;
                    
                case 'transfer_request':
                    handleTransferRequest(message);
                    break;
                    
                case 'transfer_response':
                    handleTransferResponse(message);
                    break;
                    
                case 'file_metadata':
                    handleFileMetadata(message);
                    break;
                    
                case 'transfer_error':
                    handleTransferError(message);
                    break;
                    
                default:
                    console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
            }
        }
        
        // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯
        function handleBinaryMessage(blob) {
            if (!receivingFile) return;
            
            receivedChunks.push(blob);
            receivedSize += blob.size;
            
            // æ›´æ–°è¿›åº¦
            const progress = Math.round((receivedSize / totalSize) * 100);
            receiverBar.value = progress;
            receiverPercent.textContent = `${progress}%`;
            
            // è®¡ç®—é€Ÿåº¦
            const elapsedTime = (Date.now() - transferStartTime) / 1000;
            const speedBps = receivedSize / elapsedTime;
            receiverSpeed.textContent = formatSpeed(speedBps);
            
            // å¦‚æœä¼ è¾“å®Œæˆ
            if (receivedSize >= totalSize) {
                completeFileReceive();
            }
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
        function updateDeviceList(devices) {
            if (!devices || devices.length === 0) {
                devicesContainer.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°è®¾å¤‡</p>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                // æ’é™¤è‡ªå·±çš„è®¾å¤‡
                if (device.deviceId === deviceId) return;
                
                html += `
                    <div class="device-item">
                        <span class="device-name">${device.deviceName}</span>
                        <button onclick="selectDevice('${device.deviceId}', '${device.deviceName}')">é€‰æ‹©</button>
                    </div>
                `;
            });
            
            if (html === '') {
                devicesContainer.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°å…¶ä»–è®¾å¤‡</p>';
            } else {
                devicesContainer.innerHTML = html;
            }
        }
        
        // é€‰æ‹©è®¾å¤‡
        function selectDevice(id, name) {
            targetDeviceId = id;
            targetDeviceName = name;
            
            targetDeviceNameElement.textContent = name;
            fileTransferElement.style.display = 'block';
            
            showNotification(`å·²é€‰æ‹©è®¾å¤‡: ${name}`);
        }
        
        // å‘é€æ–‡ä»¶ä¼ è¾“è¯·æ±‚
        function sendFileTransferRequest() {
            if (!selectedFile || !targetDeviceId) {
                showNotification('è¯·é€‰æ‹©æ–‡ä»¶å’Œç›®æ ‡è®¾å¤‡');
                return;
            }
            
            const message = {
                type: 'request_transfer',
                targetDeviceId: targetDeviceId,
                fileName: selectedFile.name,
                fileSize: selectedFile.size,
                fileType: selectedFile.type
            };
            
            socket.send(JSON.stringify(message));
            showNotification(`ä¼ è¾“è¯·æ±‚å·²å‘é€åˆ° ${targetDeviceName}`);
        }
        
        // å¤„ç†ä¼ è¾“è¯·æ±‚
        function handleTransferRequest(message) {
            currentTransferId = message.transferId;
            sourceDeviceNameElement.textContent = message.sourceDeviceName;
            fileNameElement.textContent = message.fileName;
            fileSizeElement.textContent = formatSize(message.fileSize);
            
            // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
            totalSize = message.fileSize;
            
            transferRequestElement.style.display = 'block';
            showNotification(`æ”¶åˆ°æ¥è‡ª ${message.sourceDeviceName} çš„æ–‡ä»¶ä¼ è¾“è¯·æ±‚`);
        }
        
        // å¤„ç†ä¼ è¾“å“åº”
        function handleTransferResponse(message) {
            if (message.accepted) {
                showNotification('ä¼ è¾“è¯·æ±‚å·²æ¥å—ï¼Œå¼€å§‹å‘é€æ–‡ä»¶...');
                currentTransferId = message.transferId;
                startFileSending();
            } else {
                showNotification('ä¼ è¾“è¯·æ±‚è¢«æ‹’ç»');
                resetSendState();
            }
        }
        
        // å¤„ç†æ–‡ä»¶å…ƒæ•°æ®
        function handleFileMetadata(message) {
            // ä¿å­˜ä¼ è¾“ID
            currentTransferId = message.transferId;
            
            // å‡†å¤‡æ¥æ”¶æ–‡ä»¶
            receivingFile = {
                name: message.fileName,
                size: message.fileSize,
                type: message.fileType
            };
            
            receivedChunks = [];
            receivedSize = 0;
            totalSize = message.fileSize;
            transferStartTime = Date.now();
            
            // æ˜¾ç¤ºè¿›åº¦
            receiverProgressElement.style.display = 'block';
            receiverBar.max = 100;
            receiverBar.value = 0;
        }
        
        // å¼€å§‹å‘é€æ–‡ä»¶
        function startFileSending() {
            if (!selectedFile) return;
            
            // æ˜¾ç¤ºè¿›åº¦
            progressContainer.style.display = 'block';
            progressBar.max = 100;
            progressBar.value = 0;
            
            // å‘é€æ–‡ä»¶å…ƒæ•°æ®
            const metadata = {
                type: 'file_metadata',
                transferId: currentTransferId,
                fileName: selectedFile.name,
                fileSize: selectedFile.size,
                fileType: selectedFile.type
            };
            
            socket.send(JSON.stringify(metadata));
            
            // å¼€å§‹è®¡æ—¶
            transferStartTime = Date.now();
            
            // å¼€å§‹å‘é€åˆ†ç‰‡
            sendFileChunks(selectedFile, 0);
        }
        
        // å‘é€æ–‡ä»¶åˆ†ç‰‡
        function sendFileChunks(file, offset) {
            if (offset >= file.size) {
                // ä¼ è¾“å®Œæˆ
                showNotification('æ–‡ä»¶å‘é€å®Œæˆï¼');
                progressBar.value = 100;
                progressPercent.textContent = '100%';
                transferSpeed.textContent = '';
                return;
            }
            
            const chunk = file.slice(offset, offset + CHUNK_SIZE);
            socket.send(chunk);
            
            // æ›´æ–°è¿›åº¦
            const progress = Math.round((offset / file.size) * 100);
            progressBar.value = progress;
            progressPercent.textContent = `${progress}%`;
            
            // è®¡ç®—é€Ÿåº¦
            const elapsedTime = (Date.now() - transferStartTime) / 1000;
            const speedBps = offset / elapsedTime;
            transferSpeed.textContent = formatSpeed(speedBps);
            
            // ç»§ç»­å‘é€ä¸‹ä¸€ä¸ªåˆ†ç‰‡
            setTimeout(() => {
                sendFileChunks(file, offset + CHUNK_SIZE);
            }, 10);
        }
        
        // å®Œæˆæ–‡ä»¶æ¥æ”¶
        function completeFileReceive() {
            showNotification('æ–‡ä»¶æ¥æ”¶å®Œæˆï¼');
            
            // éšè—ä¼ è¾“é€Ÿç‡
            receiverSpeed.textContent = '';
            
            // åˆ›å»º Blob
            const fileBlob = new Blob(receivedChunks, { type: receivingFile.type || 'application/octet-stream' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(fileBlob);
            downloadLink.download = receivingFile.name;
            downloadLink.style.display = 'none';
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // é‡ç½®çŠ¶æ€
            resetReceiveState();
        }
        
        // é‡ç½®å‘é€çŠ¶æ€
        function resetSendState() {
            selectedFile = null;
            fileInput.value = '';
            progressContainer.style.display = 'none';
            progressBar.value = 0;
        }
        
        // é‡ç½®æ¥æ”¶çŠ¶æ€
        function resetReceiveState() {
            receivingFile = null;
            receivedChunks = [];
            receivedSize = 0;
            totalSize = 0;
            transferRequestElement.style.display = 'none';
            receiverProgressElement.style.display = 'none';
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            notificationElement.textContent = message;
            notificationElement.style.display = 'block';
            
            // ä½¿ç”¨setTimeoutç¡®ä¿CSSè¿‡æ¸¡æ•ˆæœæ­£å¸¸å·¥ä½œ
            setTimeout(() => {
                notificationElement.style.top = '20px';
            }, 10);
            
            setTimeout(() => {
                notificationElement.style.top = '-100px';
                // ç­‰å¾…è¿‡æ¸¡æ•ˆæœå®Œæˆåéšè—å…ƒç´ 
                setTimeout(() => {
                    notificationElement.style.display = 'none';
                }, 500);
            }, 3000);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        
        // æ ¼å¼åŒ–ä¼ è¾“é€Ÿåº¦
        function formatSpeed(bps) {
            if (bps < 1024) return bps.toFixed(2) + ' B/s';
            if (bps < 1024 * 1024) return (bps / 1024).toFixed(2) + ' KB/s';
            return (bps / (1024 * 1024)).toFixed(2) + ' MB/s';
        }
        
        // å¤„ç†ä¼ è¾“é”™è¯¯
        function handleTransferError(message) {
            showNotification('ä¼ è¾“é”™è¯¯: æ¥æ”¶æ–¹å¯èƒ½å·²æ–­å¼€è¿æ¥');
            resetSendState();
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        fileInput.addEventListener('change', function() {
            selectedFile = this.files[0];
            if (selectedFile) {
                showNotification(`å·²é€‰æ‹©æ–‡ä»¶: ${selectedFile.name} (${formatSize(selectedFile.size)})`);
            }
        });
        
        sendButton.addEventListener('click', sendFileTransferRequest);
        
        document.getElementById('refresh-button').addEventListener('click', function() {
            this.style.transform = 'rotate(360deg)';
            showNotification('æ­£åœ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨...');
            // å‘é€è¯·æ±‚è·å–æœ€æ–°è®¾å¤‡åˆ—è¡¨
            const message = {
                type: 'request_device_list'
            };
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                showNotification('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
            // é‡ç½®æ—‹è½¬åŠ¨ç”»
            setTimeout(() => {
                this.style.transform = 'rotate(0deg)';
            }, 1000);
        });
        
        acceptButton.addEventListener('click', function() {
            const response = {
                type: 'transfer_response',
                transferId: currentTransferId,
                accepted: true
            };
            
            socket.send(JSON.stringify(response));
        });
        
        rejectButton.addEventListener('click', function() {
            const response = {
                type: 'transfer_response',
                transferId: currentTransferId,
                accepted: false
            };
            
            socket.send(JSON.stringify(response));
            resetReceiveState();
        });
        
        // åˆå§‹åŒ–
        window.onload = function() {
            initWebSocket();
            initInfoIcon();
        };
        
        // åˆå§‹åŒ–ä¿¡æ¯å›¾æ ‡
        function initInfoIcon() {
            const infoIcon = document.getElementById('info-icon');
            const infoTooltip = document.getElementById('info-tooltip');
            const ipAddressElement = document.getElementById('ip-address');
            const wsPortElement = document.getElementById('ws-port');
            const fullAddressElement = document.getElementById('full-address');
            
            // è·å–å½“å‰ä¸»æœºåå’Œç«¯å£
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            const wsProtocol = protocol === 'https:' ? 'wss:' : 'ws:';
            
            ipAddressElement.textContent = hostname;
            wsPortElement.textContent = port || (protocol === 'https:' ? '443' : '80');
            fullAddressElement.textContent = `${wsProtocol}//${hostname}${port ? ':'+port : ''}/file-transfer`;
            
            // æ˜¾ç¤º/éšè—æç¤ºæ¡†
            infoIcon.addEventListener('mouseenter', function() {
                infoTooltip.style.display = 'block';
            });
            
            infoIcon.addEventListener('mouseleave', function() {
                infoTooltip.style.display = 'none';
            });
        }
    </script>
</body>
</html>